name: YTB Tracker - Main Process

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'

  schedule:
    - cron: "0 7 * * *"  # Midnight PDT (during daylight saving time)
    - cron: "0 8 * * *"  # Midnight PST (during standard time)

jobs:
  build-linux:
    name: youtube-automation
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write
      issues: write

    env:
      CREDS_B64: '${{ secrets.CREDS_B64 }}'
      GITHUB_REPOSITORY: '${{ github.GITHUB_REPOSITORY }}'
      PAT: '${{ secrets.PAT }}'

    steps:
      - id: check-schedule
        name: Validate Schedule for Current Timezone
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual run. Proceeding."
            echo "should_run=true" >> $GITHUB_ENV
            exit 0
          fi

          # Get which cron triggered this run
          trigger="${{ github.event.schedule }}"
          pt_offset=$(TZ="America/Los_Angeles" date +%z)

          echo "Triggered by: $trigger"
          echo "Pacific Time offset: $pt_offset"

          if [ "$trigger" = "0 7 * * *" ] && [ "$pt_offset" = "-0700" ]; then
            echo "7 AM UTC trigger + PDT = midnight PDT. Proceeding."
            echo "should_run=true" >> $GITHUB_ENV
          elif [ "$trigger" = "0 8 * * *" ] && [ "$pt_offset" = "-0800" ]; then
            echo "8 AM UTC trigger + PST = midnight PST. Proceeding."
            echo "should_run=true" >> $GITHUB_ENV
          else
            echo "Wrong schedule for current timezone. Skipping."
            echo "should_run=false" >> $GITHUB_ENV
          fi

      - id: git-checkout
        name: Checkout repository
        if: env.should_run == 'true'
        uses: actions/checkout@v6

      - id: uv-setup
        name: Set up uv
        if: env.should_run == 'true'
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - id: python-setup
        name: Set up Python 3.12
        if: env.should_run == 'true'
        run: uv python install 3.12

      - id: dependencies
        name: Install dependencies
        if: env.should_run == 'true'
        run: uv sync --extra dev

      - id: ruff
        name: Lint with ruff
        if: env.should_run == 'true'
        run: |
          uv run ruff check . --select=E9,F63,F7,F82
          uv run ruff check . --exit-zero

      - id: main
        name: Main process execution
        if: env.should_run == 'true'
        run: uv run python -m yrt.main action

      - id: commit
        name: Commit changes (Log and historical data)
        if: env.should_run == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions"
          git commit -m "log: Latest execution report." -a

      - id: push
        name: Push changes
        if: env.should_run == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - id: notify-failure
        name: Create issue on workflow failure
        if: failure() && env.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Workflow failed: ${context.workflow}`,
              body: `The workflow **${context.workflow}** has failed.\n\n**Run details:** ${runUrl}\n\n**Triggered by:** ${context.eventName}\n**Date:** ${new Date().toISOString()}`,
              labels: ['üêõ bug', '‚ö†Ô∏è workflow-failure']
            });
