name: YTB Tracker - Main Process

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'

  schedule:
    - cron: "0 7 * * *"  # Runs at 7:00 AM UTC, waits until midnight PT (auto-adjusts for PST/PDT)

jobs:
  build-linux:
    name: youtube-automation
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    env:
      CREDS_B64: '${{ secrets.CREDS_B64 }}'
      GITHUB_REPOSITORY: '${{ github.GITHUB_REPOSITORY }}'
      PAT: '${{ secrets.PAT }}'

    steps:
      - id: check-event
        name: Check Trigger Event
        run: |
          # Check if the event is 'schedule' or 'workflow_dispatch'
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "This is a scheduled run. Performing the midnight PST check."
            echo "proceed_with_check=true" >> $GITHUB_ENV
          else
            echo "This is a manual run. Skipping the midnight PST check."
            echo "proceed_with_check=false" >> $GITHUB_ENV
          fi

      - id: set-up-tz
        name: Set Up Timezone
        if: env.proceed_with_check == 'true'
        run: |
          # Install timezone data
          sudo apt-get update && sudo apt-get install -y tzdata
          echo "Timezone data installed"

      - id: wait-0000-pst
        name: Wait Until Midnight PT (PST/PDT)
        if: env.proceed_with_check == 'true'
        run: |
          while true; do
            # Get the current hour and minute in Pacific Time (handles PST/PDT automatically)
            current_hour=$(TZ="America/Los_Angeles" date +'%H')
            current_minute=$(TZ="America/Los_Angeles" date +'%M')
          
            # Check if it's midnight hour (00:00-00:59) or later
            if [ "$current_hour" -eq 0 ]; then
              echo "It's midnight PT or later! Current time: $current_hour:$current_minute PT. Proceeding."
              break
            else
              echo "Not midnight PT yet. Current time: $current_hour:$current_minute PT. Waiting..."
              sleep 60 # Wait for 1 minute before checking again
            fi
          done

      - id: git-checkout
        name: Checkout repository
        uses: actions/checkout@v6

      - id: uv-setup
        name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - id: python-setup
        name: Set up Python 3.12
        run: uv python install 3.12

      - id: dependencies
        name: Install dependencies
        run: uv sync --extra dev

      - id: ruff
        name: Lint with ruff
        run: |
          uv run ruff check . --select=E9,F63,F7,F82
          uv run ruff check . --exit-zero

      - id: main
        name: Main process execution
        run: uv run python -m yrt.main action

      - id: commit
        name: Commit changes (Log and historical data)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions"
          git commit -m "log: Latest execution report." -a

      - id: push
        name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: true
